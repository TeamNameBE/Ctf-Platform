{% extends 'base.html' %}

{% block content %}
    <div class="row ms-4">
        <div class="overflow-y-auto col-6 row-element mt-3" style="max-height: 95vh;">

            <div class="accordion" id="ChallengeAccordion">
                {% for chall in challenges %}
                    {% include "includes/challenge_accordion.html" %}
                {% endfor %}
            </div>

            <div class="modal fade" id="AddChallengeModal" tabindex="-1" role="dialog" aria-labelledby="AddChallengeModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title" id="AddChallengeModalLabel">Add new challenge</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form method="post" class="no-smoothState">
                                {% csrf_token %}
                                <label class="block">
                                    <span class="text-gray-700">Name:</span>
                                    <input type="text" name="name" maxlength="200" required="true" id="id_name" class="rounded-md mb-2">
                                </label>
                                <label class="block mt-4">
                                    <span class="text-gray-700">Points:</span>
                                    <input type="number" name="points" value="0" required="true" id="id_points" class="rounded-md mb-2">
                                </label>
                                <label class="block mt-4">
                                    <span class="text-gray-700">Description:</span>
                                    <textarea name="description" required="" id="id_description" class="form-textarea mt-1 block w-full" rows="3"></textarea>
                                </label>
                                <label class="block mt-4">
                                    <span class="text-gray-700">Category:</span>
                                    <select name="category" required="" id="id_category" multiple="true" class="form-multiselect block w-full mt-1">
                                        {% for x, y in AddChallenge.fields.category.choices %}
                                            <option value="{{ x }}"{% if AddChallenge.fields.category.value == x %} selected{% endif %}>{{ y }}</option>
                                        {% endfor %}
                                    </select>
                                </label>
                                <input type="submit" value="Submit" class="mt-4 px-6 py-3 text-white bg-green-700 active:bg-green-900 rounded-md">
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div style="position: absolute;left: 2vw;bottom: 2vh;">
                <button type="button" class="mt-2 btn btn-lg btn-primary" data-bs-toggle="modal" data-bs-target="#AddChallengeModal">➕ Add a Challenge</button>
            </div>

            <div class="modal fade" id="EditChallengeModal" tabindex="-1" role="dialog" aria-labelledby="EditChallengeModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title" id="EditChallengeModalLabel">Edit Challenge</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body" id="EditChallengeForm">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <iframe class="col-6 row-element" src="{{ ctf.padLink }}" frameborder="0" id="LePad" style="height: 95vh"></iframe>
        {% comment %}
        On va pas se mentir, ça sert à rien le bouton fullscreen
        <button onclick="fullscreen()" class="px-6 py-3 text-white bg-gray-500 bg-opacity-70 rounded-md" style="position:absolute;bottom:5%;right:1%;">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
            </svg>
        </button>
        {% endcomment %}
    </div>

    <script>
        function getForm(id) {
            var base_url = "{% url 'chal' ctf.id %}";
            var url = base_url + "/edit/" + id;
            fetch(url)
            .then(response => response.text())
            .then(html => {
                    $("#EditChallengeForm").html(html);
                    $('#EditChallengeModal').modal('show');
                })
            .catch(err => console.warn('Something went wrong.', err));
        };

        function startProcessing(file_id){
            $(`#process_file${file_id}`).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>Loading...');
            fetch(`{% url 'start_processing' %}?file_id=${file_id}`)
            .then(response => {
                if (response.ok) {
                    $(`#process_file${file_id}`).html('✔️ processed');
                } else {
                    throw new Error(response.text);
                }
            })
            .catch((error) => {
                $(`#process_file${file_id}`).html('❌ error');
            });
        }

        function downloadFile(url){
            window.location = url;
        }
    </script>
{% endblock %}
