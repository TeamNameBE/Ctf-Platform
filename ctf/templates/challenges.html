{% extends 'base.html' %}

{% block content %}
    <div class="row ms-4">
        <div class="overflow-y-auto col-6 row-element mt-3" style="max-height: 95vh;">

            <div class="accordion" id="ChallengeAccordion">
                {% for chall in challenges %}
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingOne">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                {{ chall.name }} <small class="text-muted ms-2 me-2">{{ chall.points }}pts</small>
                                <div class="text-sm">
                                    {% for category in chall.category.all %}
                                        <span class="badge" style="background-color: {{ category.color }}">{{ category.name }}</span>
                                    {% endfor %}
                                </div>
                            </button>
                        </h2>
                        <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#ChallengeAccordion">
                            <div class="container" id="Challenge{{chall.id}}-render">
                                <h4>Description: </h4>
                                <p>{{ chall.description }}</p>

                                <h3>Files</h3>
                                <ul class="list overflow-y-auto">
                                    {% for file in chall.challengefile_set.all %}
                                        <li>
                                            <a class="no-smoothState" href="/media/{{ file }}" style="display:inline-block;">
                                                <div class="underline text-blue-700" style="display:inline-block;font-size:1.25em;">{{ file }}</div>
                                            </a>
                                        </li>
                                    {% empty %}
                                        <li>No files</li>
                                    {% endfor %}
                                </ul>
                                <form action="{% url "upload_file" ctf.id chall.id %}" method="POST" id="uploadForm{{ chall.id }}" enctype="multipart/form-data" class="no-smoothState">
                                    {% csrf_token %}
                                    <input onchange="$('#uploadForm{{ chall.id }}').submit()" class="mt-2" type="file" id="files" name="file"></input>
                                </form>
                            </div>

                            <div class="modal-footer">
                                <button onclick="window.location = '{% url "validate_chall" ctf.id chall.id %}'" class="btn btn-primary"> Validate </button>
                                <button onclick="getForm({{ chall.id }})" class="btn btn-danger"> Edit </button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <div class="modal fade" id="AddChallengeModal" tabindex="-1" role="dialog" aria-labelledby="AddChallengeModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title" id="AddChallengeModalLabel">Add new challenge</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form method="post" class="no-smoothState">
                                {% csrf_token %}
                                <label class="block">
                                    <span class="text-gray-700">Name:</span>
                                    <input type="text" name="name" maxlength="200" required="true" id="id_name" class="rounded-md mb-2">
                                </label>
                                <label class="block mt-4">
                                    <span class="text-gray-700">Points:</span>
                                    <input type="number" name="points" value="0" required="true" id="id_points" class="rounded-md mb-2">
                                </label>
                                <label class="block mt-4">
                                    <span class="text-gray-700">Description:</span>
                                    <textarea name="description" required="" id="id_description" class="form-textarea mt-1 block w-full" rows="3"></textarea>
                                </label>
                                <label class="block mt-4">
                                    <span class="text-gray-700">Category:</span>
                                    <select name="category" required="" id="id_category" multiple="true" class="form-multiselect block w-full mt-1">
                                        {% for x, y in AddChallenge.fields.category.choices %}
                                            <option value="{{ x }}"{% if AddChallenge.fields.category.value == x %} selected{% endif %}>{{ y }}</option>
                                        {% endfor %}
                                    </select>
                                </label>
                                <input type="submit" value="Submit" class="mt-4 px-6 py-3 text-white bg-green-700 active:bg-green-900 rounded-md">
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div style="position: absolute;left: 2vw;bottom: 2vh;">
                <button type="button" class="mt-2 btn btn-lg btn-primary" data-bs-toggle="modal" data-bs-target="#AddChallengeModal">➕ Add a Challenge</button>
            </div>

            <div class="modal fade" id="EditChallengeModal" tabindex="-1" role="dialog" aria-labelledby="EditChallengeModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title" id="EditChallengeModalLabel">Edit Challenge</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body" id="EditChallengeForm">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <iframe class="col-6 row-element" src="{{ ctf.padLink }}" frameborder="0" id="LePad" style="height: 95vh"></iframe>
        {% comment %}
        On va pas se mentir, ça sert à rien le bouton fullscreen
        <button onclick="fullscreen()" class="px-6 py-3 text-white bg-gray-500 bg-opacity-70 rounded-md" style="position:absolute;bottom:5%;right:1%;">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
            </svg>
        </button>
        {% endcomment %}
    </div>

    <script>
        function getForm(id) {
            var base_url = "{% url 'chal' ctf.id %}";
            var url = base_url + "/edit/" + id;
            fetch(url)
            .then(response => response.text())
            .then(html => {
                    $("#EditChallengeForm").html(html);
                    $('#EditChallengeModal').modal('show');
                })
            .catch(err => console.warn('Something went wrong.', err));
        };
    </script>
{% endblock %}